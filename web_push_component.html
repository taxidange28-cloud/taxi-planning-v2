<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Web Push Notifications</title>
</head>
<body>
    <div id="notification-status"></div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-messaging-compat.js"></script>

    <script>
        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCe08U4nEDIK9COhMUAWmz8YuxoCluZKfY",
            authDomain: "transport-dange.firebaseapp.com",
            projectId: "transport-dange",
            storageBucket: "transport-dange.firebasestorage.app",
            messagingSenderId: "86580303208",
            appId: "1:86580303208:web:fc2e8da737045a29dbf2dd"
        };

        // Cl√© VAPID
        const vapidKey = "BJyRYRH1eyGZiFFSIk5dSy1XlJn5GQKD_1KLT1OhaTm6vsjTV2kiZXePJqS6kGbeZvzQUgNPO6xsk712YmcluL8";

        // Initialiser Firebase
        firebase.initializeApp(firebaseConfig);
        const messaging = firebase.messaging();

        // Fonction pour demander la permission et obtenir le token
        async function requestNotificationPermission() {
            try {
                console.log('üì± Demande de permission pour les notifications...');
                
                const permission = await Notification.requestPermission();
                
                if (permission === 'granted') {
                    console.log('‚úÖ Permission accord√©e !');
                    
                    // Obtenir le token FCM
                    const token = await messaging.getToken({ vapidKey: vapidKey });
                    
                    if (token) {
                        console.log('üîë Token FCM obtenu:', token);
                        
                        // Envoyer le token √† Streamlit
                        window.parent.postMessage({
                            type: 'FCM_TOKEN',
                            token: token
                        }, '*');
                        
                        document.getElementById('notification-status').innerHTML = 
                            '<div style="background: #d4edda; color: #155724; padding: 10px; border-radius: 5px; margin: 10px 0;">' +
                            '‚úÖ Notifications activ√©es ! Vous recevrez les nouvelles courses avec un son.</div>';
                        
                        return token;
                    }
                } else if (permission === 'denied') {
                    console.log('‚ùå Permission refus√©e');
                    document.getElementById('notification-status').innerHTML = 
                        '<div style="background: #f8d7da; color: #721c24; padding: 10px; border-radius: 5px; margin: 10px 0;">' +
                        '‚ùå Notifications bloqu√©es. Activez-les dans les param√®tres de Chrome.</div>';
                } else {
                    console.log('‚ö†Ô∏è Permission en attente');
                }
            } catch (error) {
                console.error('‚ùå Erreur permission notifications:', error);
                document.getElementById('notification-status').innerHTML = 
                    '<div style="background: #fff3cd; color: #856404; padding: 10px; border-radius: 5px; margin: 10px 0;">' +
                    '‚ö†Ô∏è Erreur: ' + error.message + '</div>';
            }
        }

        // G√©rer les notifications en premier plan
        messaging.onMessage((payload) => {
            console.log('üì¨ Notification re√ßue en premier plan:', payload);
            
            const notificationTitle = payload.notification.title || 'üÜï Nouvelle course';
            const notificationOptions = {
                body: payload.notification.body,
                icon: '/favicon.ico',
                badge: '/favicon.ico',
                tag: 'nouvelle-course',
                requireInteraction: true,
                vibrate: [200, 100, 200, 100, 200],
                data: payload.data
            };

            // Afficher la notification
            if (Notification.permission === 'granted') {
                new Notification(notificationTitle, notificationOptions);
                
                // Jouer un son (bip grave)
                playNotificationSound();
            }
            
            // Notifier Streamlit qu'une nouvelle notification est arriv√©e
            window.parent.postMessage({
                type: 'NEW_NOTIFICATION',
                data: payload
            }, '*');
        });

        // Fonction pour jouer le son de notification (bip grave)
        function playNotificationSound() {
            try {
                // Cr√©er un contexte audio
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // Cr√©er un oscillateur (g√©n√©rateur de son)
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                // Configuration du bip grave
                oscillator.type = 'sine'; // Onde sinuso√Ødale pour un son doux
                oscillator.frequency.setValueAtTime(200, audioContext.currentTime); // 200 Hz = grave
                
                // Configuration du volume
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                // Connecter les n≈ìuds
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                // Jouer le son
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
                
                console.log('üîä Son de notification jou√©');
            } catch (error) {
                console.error('‚ùå Erreur lecture son:', error);
            }
        }

        // Enregistrer le Service Worker
        async function registerServiceWorker() {
            try {
                if ('serviceWorker' in navigator) {
                    console.log('üîß Enregistrement du Service Worker...');
                    
                    // Note: Sur Streamlit Cloud, le Service Worker ne peut pas √™tre enregistr√©
                    // √† la racine, donc les notifications en arri√®re-plan ne fonctionneront pas.
                    // Seules les notifications en premier plan (app ouverte) fonctionneront.
                    
                    console.log('‚ö†Ô∏è Service Worker non disponible sur Streamlit Cloud');
                    console.log('‚úÖ Notifications en premier plan activ√©es (app ouverte uniquement)');
                }
            } catch (error) {
                console.error('‚ùå Erreur Service Worker:', error);
            }
        }

        // Initialiser au chargement
        window.addEventListener('load', async () => {
            console.log('üöÄ Initialisation des notifications Web Push...');
            
            // V√©rifier le support des notifications
            if (!('Notification' in window)) {
                console.error('‚ùå Les notifications ne sont pas support√©es par ce navigateur');
                document.getElementById('notification-status').innerHTML = 
                    '<div style="background: #f8d7da; color: #721c24; padding: 10px; border-radius: 5px;">' +
                    '‚ùå Votre navigateur ne supporte pas les notifications.</div>';
                return;
            }
            
            // Enregistrer le Service Worker
            await registerServiceWorker();
            
            // Demander la permission si pas encore accord√©e
            if (Notification.permission === 'default') {
                await requestNotificationPermission();
            } else if (Notification.permission === 'granted') {
                // Permission d√©j√† accord√©e, obtenir le token
                try {
                    const token = await messaging.getToken({ vapidKey: vapidKey });
                    if (token) {
                        console.log('üîë Token FCM (d√©j√† autoris√©):', token);
                        window.parent.postMessage({
                            type: 'FCM_TOKEN',
                            token: token
                        }, '*');
                        
                        document.getElementById('notification-status').innerHTML = 
                            '<div style="background: #d4edda; color: #155724; padding: 10px; border-radius: 5px;">' +
                            '‚úÖ Notifications d√©j√† activ√©es</div>';
                    }
                } catch (error) {
                    console.error('‚ùå Erreur r√©cup√©ration token:', error);
                }
            } else {
                document.getElementById('notification-status').innerHTML = 
                    '<div style="background: #f8d7da; color: #721c24; padding: 10px; border-radius: 5px;">' +
                    '‚ùå Notifications bloqu√©es. Activez-les dans les param√®tres de Chrome.</div>';
            }
        });

        // Message pour d√©boguer
        console.log('‚úÖ Composant Web Push charg√©');
    </script>
</body>
</html>
